## 链的环境搭建

### 硬件检查

step 1: 

- cpu 型号支持 sgx

step 2: 

- BIOS  关闭 hyperthreading,   关闭 undervolting (Turboboost) 

​     开机进入BIOS 设置模式，进入cpu 设置的模式找到相关配置关闭相关功能。

### 软件安装

- OS  ubuntu20.04

#### 安装SGX 环境

1. 可以使用提供好的脚本

```
# 下载官方提供好的脚本
wget https://raw.githubusercontent.com/SecretFoundation/docs/main/docs/node-guides/sgx
# 赋予执行权限
chmod +x sgx
# 执行安装脚本
bash sgx
```

```bash
#! /bin/bash
# 脚本内容如下：
sudo apt-get update && sudo apt upgrade -y
sudo apt-get install make build-essential gcc git jq chrony -y

UBUNTUVERSION=$(lsb_release -r -s | cut -d '.' -f 1)
PSW_PACKAGES='libsgx-enclave-common libsgx-urts sgx-aesm-service libsgx-uae-service autoconf libtool make gcc'

if (($UBUNTUVERSION < 16)); then
	echo "Your version of Ubuntu is not supported. Must have Ubuntu 16.04 and up. Aborting installation script..."
	exit 1
elif (($UBUNTUVERSION == 16)); then
	DISTRO='xenial'
	OS='ubuntu16.04-server'
elif (($UBUNTUVERSION == 18)); then
	DISTRO='bionic'
	OS='ubuntu18.04-server'
elif (($UBUNTUVERSION == 20)); then
	DISTRO='focal'
	OS='ubuntu20.04-server'
fi

echo "\n\n###############################################"
echo "#####       Installing Intel SGX driver       #####"
echo "###############################################\n\n"

# Download SGX driver
if (($UBUNTUVERSION == 16)); then
   # Ubuntu 16 was deprecated by the latest Intel SGX drivers
   wget "https://download.01.org/intel-sgx/sgx-linux/2.13/distro/${OS}/sgx_linux_x64_driver_2.11.0_0373e2e.bin"
else
   wget "https://download.01.org/intel-sgx/sgx-linux/2.14/distro/${OS}/sgx_linux_x64_driver_2.11.0_2d2b795.bin"
fi

# Make the driver installer executable
chmod +x ./sgx_linux_x64_driver_*.bin

# Install the driver
sudo ./sgx_linux_x64_driver_*.bin

# Remount /dev as exec, also at system startup
sudo tee /etc/systemd/system/remount-dev-exec.service >/dev/null <<EOF
[Unit]
Description=Remount /dev as exec to allow AESM service to boot and load enclaves into SGX

[Service]
Type=oneshot
ExecStart=/bin/mount -o remount,exec /dev
RemainAfterExit=true

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl enable remount-dev-exec
sudo systemctl start remount-dev-exec

echo "\n\n###############################################"
echo "#####       Installing Intel SGX PSW          #####"
echo "###############################################\n\n"

# Add Intels's SGX PPA
echo "deb [arch=amd64] https://download.01.org/intel-sgx/sgx_repo/ubuntu $DISTRO main" |
   sudo tee /etc/apt/sources.list.d/intel-sgx.list
wget -qO - https://download.01.org/intel-sgx/sgx_repo/ubuntu/intel-sgx-deb.key |
   sudo apt-key add -
sudo apt update

# Install libprotobuf
if (($UBUNTUVERSION > 18)); then
   sudo apt install -y gdebi
   # Install all the additional necessary dependencies (besides the driver and the SDK)
   # for building a rust enclave
   wget -O /tmp/libprotobuf30_3.19.4-1_amd64.deb https://engfilestorage.blob.core.windows.net/filestorage/libprotobuf30_3.19.4-1_amd64.deb
   yes | sudo gdebi /tmp/libprotobuf30_3.19.4-1_amd64.deb
else
   PSW_PACKAGES+=' libprotobuf-dev'
fi

sudo apt install -y $PSW_PACKAGES
```

2. 检查是否安装成功

```bash
ls /dev/isgx
```

安装成功会挂载 isgx 设备。

3. 安装 sgx sdk

​       脚本已经安装了sgx 开发相关组件，我们还需要再安装 sgx sdk，编译需要依赖相关文件。

```bash
wget https://download.01.org/intel-sgx/sgx-linux/2.14/distro/ubuntu20.04-server/sgx_linux_x64_sdk_2.14.100.2.bin

chmod +x sgx_linux_x64_sdk_2.14.100.2.bin

bash sgx_linux_x64_sdk_2.14.100.2.bin

# 提示安装目录 一般我们安装再 /root/.sgxsdk 下面
# 输入  .sgxsdk (假设你是再root下)
```



#### 安装 rust 环境

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# 安装完成后还需要添加一些支持工具
rustup component add rust-src clippy
rustup target add wasm32-unknown-unknown
cargo +stable install xargo
```

#### 安装 go 环境

go 版本 1.17 以上

```bash
安装go 之后 将 go-bindata 安装上
apt install go-bindata
```

#### 安装相关工具软件

```bash
wget https://github.com/mozilla/sccache/releases/download/0.2.13/sccache-0.2.13-x86_64-unknown-linux-musl.tar.gz

tar xf ./sccache-*.tar.gz

mv ./sccache*/sccache "$HOME/sccache"
```

### 编译项目

拉取项目

```bash
git clone https://github.com/HermitMatrixNetwork/HermitMatrixNetwork.git
```

进入项目目录

```bash
cd HermitMatrixNetwork
```

添加 spid, api_key

```bash
mkdir -p ias_keys/develop

# 将相应的spid.txt   api_key.txt  放入相关目录下面
```

编译

```bash
source "$HOME/.sgxsdk/sgxsdk/environment"
make vendor
SGX_MODE=HW BUILD_PROFILE="release" RUSTC_WRAPPER="$HOME/sccache" make build-linux
```

编译成功，生产ghmcli, ghmd ， 然后我们可以制作一个deb 包

```bash
VERSION=0.0.1 make deb-no-compile
```
成功打包之后，输出在当前目录。

使用 dpkg 安装
```bash
dpkg -i xxxxxxx.deb
```

如果需要卸载，使用 -r 指定包名
```bash
dpkg -r hermitmatrixnetwork
```