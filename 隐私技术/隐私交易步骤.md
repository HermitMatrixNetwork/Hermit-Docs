# 隐私交易步骤

1. 使用 Eliptic-Curve Diffie Hellman 密钥交换 (ECDH)，用户从他们的私钥和 Hermit Network 公钥生成共享密钥。网络可以使用用户公钥和网络私钥（仅在可信执行环境 (TEE) 中可用）生成相同的共享密钥。

2. 然后，用户`tx_encryption_key`使用 HKDF-SHA256 和步骤 1 中生成的共享密钥生成共享。伪随机 HDKF 用于确保所有节点之间的确定性共识。随机分量来自 256 位随机数，因此每笔交易都有自己的加密密钥，AES-256-GCM 加密密钥永远不会使用两次。

3. 启动交易后，用户使用共享交易加密密钥加密输入数据，使用 AES-256-GCM 认证的加密方案。

4. 然后，用户将带有加密输入数据、GHM 中的gas以及可选的 GHM 存款（根据合约要求）发送到合同地址。该交易使用用户公钥和使用的 Nonce 发布消息，以便网络可以生成相同的消息`tx_encryption_key.`

5. 在 Tendermint`check_tx`被认为成功后，验证者在共享内存池中接收交易，并使用数据来处理交易。

6. 每个验证器都在具有 Intel SGX 兼容 CPU 的机器上运行。该 CPU 内的 enclave 是可信组件，而从外部与 enclave 交互的进程是不可信组件。加密的交易输入从不受信任的组件传递到受信任的组件。

7. enclave 使用 ECDH 从用户公钥和网络私钥中导出相同的共享秘密。然后，网络`tx_encryption_key`使用 HDKF 从公共签名的 nonce 和这个共享的秘密中导出。在可信组件中，交易输入被解密为明文。

8. 请求的合约计算由 WASMI 运行时在明文输入上执行，该运行时在受信任的 enclave 内实例化。

9. 每次计算都有几种可能的结果，所有这些结果都同时发生在链上：

- 合同状态已更新。
- 交易输出为交易发送者加密并在链上提交
- 如果存在，则回调其他合约。
- 如果存在，将消息发送到其他模块。

10. 计算的输出使用`tx_encryption_key `AES-256-GCM 认证的加密方案进行加密。

11. 然后将加密的输出返回到验证器节点的不受信任的组件。

12. 提议当前区块的验证者广播加密的输出。

13. 其他验证者将他们的结果与区块提议者的结果进行比较。如果超过三分之二的当前投票权同意结果，则提议的区块（以及其中的所有交易）将包含在网络中。